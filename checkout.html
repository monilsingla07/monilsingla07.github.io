<!doctype html>
<html>
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CKQ1EXBHY6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-CKQ1EXBHY6');
</script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkout — AhamStree</title>
  <meta name="description" content="Secure checkout. Shipping details and Razorpay payment." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="assets/styles.css" />
  <link rel="stylesheet" href="assets/styles.css" />
</head>

<body>
  <div id="header"></div>

  <div class="container">
    <div class="breadcrumbs" aria-label="Breadcrumb">
      <a href="index.html">Home</a> <span class="sep">›</span>
      <a href="cart.html">Cart</a> <span class="sep">›</span>
      <span>Checkout</span>
    </div>

    <div class="page-header">
      <div>
        <h1 class="page-title">Checkout</h1>
        <div class="small page-subtitle">Confirm your cart, add shipping details, and pay securely via Razorpay.</div>
      </div>
      <a class="btn ghost" href="cart.html" style="height:40px;">Edit cart</a>
    </div>

    <div id="authBanner" class="card" style="padding:12px 14px; border-radius:16px; display:none; margin-bottom:12px;">
      <div class="small" id="authText"></div>
    </div>

    <div id="warn" class="card" style="padding:12px 14px; border-radius:16px; display:none; border:1px solid rgba(220,20,60,.22); margin-bottom:12px;">
      <div class="small" style="color:crimson;" id="warnText"></div>
    </div>

    <div style="display:grid; grid-template-columns: 1.4fr .9fr; gap:16px; align-items:start;" class="checkout-grid">

      <!-- LEFT: Shipping -->
      <form id="form" class="card" style="padding:16px; border-radius:16px;">
        <h3 style="margin:0 0 8px 0;">Shipping details</h3>
        <div class="small" style="opacity:.8; margin-bottom:12px;">Used for delivery updates and invoice.</div>

        <label class="small">Full name</label>
        <input class="input" name="full_name" required placeholder="e.g., Monil Gupta" />

        <div style="height:10px;"></div>

        <label class="small">Phone</label>
        <input class="input" name="phone" required maxlength="10" placeholder="10-digit mobile" inputmode="numeric" />

        <div style="height:10px;"></div>

        <label class="small">Email (optional)</label>
        <input class="input" name="email" placeholder="name@email.com" inputmode="email" />

        <div style="height:10px;"></div>

        <label class="small">Address line 1</label>
        <input class="input" name="address_line1" required placeholder="House / street" />

        <div style="height:10px;"></div>

        <label class="small">Address line 2 (optional)</label>
        <input class="input" name="address_line2" placeholder="Landmark" />

        <div style="height:10px;"></div>

        <div class="row">
          <div style="flex:1;">
            <label class="small">City</label>
            <input class="input" name="city" required />
          </div>
          <div style="flex:1;">
            <label class="small">State</label>
            <input class="input" name="state" required />
          </div>
        </div>

        <div style="height:10px;"></div>

        <label class="small">Pincode</label>
        <input class="input" name="pincode" required maxlength="6" placeholder="e.g., 560001" inputmode="numeric" />

        <div style="height:14px;"></div>

        <button class="btn" type="button" id="payBtn" style="width:100%;">Pay with Razorpay</button>
        <div id="status" class="small" style="margin-top:10px;"></div>

        <div class="small" style="margin-top:12px; opacity:.8;">
          Note: Payments are processed by Razorpay. You’ll be redirected to a secure payment page.
        </div>
      </form>

      <!-- RIGHT: Order Summary -->
      <div class="card" style="padding:16px; border-radius:16px;">
        <h3 style="margin:0 0 8px 0;">Order summary</h3>
        <div class="small" style="opacity:.8; margin-bottom:12px;">Review your items before payment.</div>

        <div id="summaryItems" style="display:flex; flex-direction:column; gap:10px;"></div>

        <div style="height:12px;"></div>
        <div style="border-top:1px solid rgba(255,255,255,.08); padding-top:12px;">
          <div style="display:flex; justify-content:space-between; gap:10px;">
            <div class="small">Subtotal</div>
            <div class="small" id="subtotal">₹0</div>
          </div>
          <div style="display:flex; justify-content:space-between; gap:10px; margin-top:6px;">
            <div class="small">Shipping</div>
            <div class="small" id="shipping">₹0</div>
          </div>
          <div style="display:flex; justify-content:space-between; gap:10px; margin-top:10px; font-weight:900;">
            <div>Total</div>
            <div id="total">₹0</div>
          </div>
        </div>

        <div style="height:12px;"></div>
        <div class="small" style="opacity:.75;">
          If payment fails or is cancelled, you can retry from your cart.
        </div>
      </div>
    </div>
  </div>

  <div id="footer"></div>

  <script type="module">
    const statusEl = document.getElementById("status");
    const warnBox = document.getElementById("warn");
    const warnText = document.getElementById("warnText");
    const payBtn = document.getElementById("payBtn");
    const form = document.getElementById("form");

    const showError = (msg) => {
      warnBox.style.display = "block";
      warnText.textContent = msg;
    };
    const clearError = () => {
      warnBox.style.display = "none";
      warnText.textContent = "";
    };

    // ---------- Money / Summary ----------
    function money(n) {
      return "₹" + Number(n || 0);
    }

    async function renderOrderSummary() {
      const summaryItems = document.getElementById("summaryItems");
      const subtotalEl = document.getElementById("subtotal");
      const shippingEl = document.getElementById("shipping");
      const totalEl = document.getElementById("total");

      if (!summaryItems || !subtotalEl || !shippingEl || !totalEl) return;

      const cartMod = await import("./assets/cart.js");
      const items = cartMod.getCart?.() || [];

      if (!items.length) {
        summaryItems.innerHTML = `<div class="small" style="opacity:.75;">Your cart is empty.</div>`;
        subtotalEl.textContent = money(0);
        shippingEl.textContent = money(0);
        totalEl.textContent = money(0);
        return;
      }

      let subtotal = 0;

      summaryItems.innerHTML = items.map((i) => {
        const lineTotal = (i.price_inr || 0) * (i.qty || 1);
        subtotal += lineTotal;

        return `
          <div style="display:flex; gap:10px; align-items:center;">
            <div style="width:54px;height:64px;border-radius:12px;overflow:hidden;background:#fafafa;flex:0 0 auto;">
              ${i.image_url ? `<img src="${i.image_url}" alt="${i.title || ""}" style="width:100%;height:100%;object-fit:cover;">` : ""}
            </div>

            <div style="flex:1; min-width:0;">
              <div style="font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                ${i.title || "Item"}
              </div>
              <div class="small" style="opacity:.75;">₹${i.price_inr} × ${i.qty}</div>
            </div>

            <div style="font-weight:900; flex:0 0 auto;">${money(lineTotal)}</div>
          </div>
        `;
      }).join("");

      const shipping = 0; // keep free for now
      const total = subtotal + shipping;

      subtotalEl.textContent = money(subtotal);
      shippingEl.textContent = money(shipping);
      totalEl.textContent = money(total);
    }

    // ---------- Validation ----------
    const isValidEmail = (email) => /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i.test(email);
    const sanitizeText = (s) => String(s || "").trim().replace(/\s+/g, " ");

    const normalizePhone10 = (raw) => {
      let digits = String(raw || "").replace(/\D/g, "");
      if (digits.startsWith("91") && digits.length === 12) digits = digits.slice(2);
      if (digits.startsWith("0") && digits.length === 11) digits = digits.slice(1);
      return digits;
    };

    const normalizePincode6 = (raw) => String(raw || "").replace(/\D/g, "");

    const markInvalid = (inputEl, msg) => {
      inputEl.classList.add("is-invalid");
      inputEl.dataset.error = msg;
    };
    const markValid = (inputEl) => {
      inputEl.classList.remove("is-invalid");
      delete inputEl.dataset.error;
    };
    const clearMarks = (inputEl) => {
      inputEl.classList.remove("is-invalid");
      delete inputEl.dataset.error;
    };

    const validateField = (name, valueRaw) => {
      const v = valueRaw;

      if (name === "full_name") {
        const full = sanitizeText(v);
        if (!full || full.length < 3) return { ok: false, message: "Enter a valid full name (min 3 chars)." };
        return { ok: true };
      }

      if (name === "phone") {
        const phone10 = normalizePhone10(v);
        if (!phone10 || phone10.length !== 10 || !/^[6-9]\d{9}$/.test(phone10)) {
          return { ok: false, message: "Enter a valid 10-digit Indian mobile (starts 6–9)." };
        }
        return { ok: true };
      }

      if (name === "email") {
        const email = sanitizeText(v).toLowerCase();
        if (!email) return { ok: true };
        if (!isValidEmail(email)) return { ok: false, message: "Enter a valid email or leave blank." };
        return { ok: true };
      }

      if (name === "address_line1") {
        const a1 = sanitizeText(v);
        if (!a1 || a1.length < 5) return { ok: false, message: "Enter Address line 1 (min 5 chars)." };
        return { ok: true };
      }

      if (name === "city") {
        const city = sanitizeText(v);
        if (!city) return { ok: false, message: "Enter your city." };
        return { ok: true };
      }

      if (name === "state") {
        const state = sanitizeText(v);
        if (!state) return { ok: false, message: "Enter your state." };
        return { ok: true };
      }

      if (name === "pincode") {
        const pin = normalizePincode6(v);
        if (!pin || pin.length !== 6) return { ok: false, message: "Enter a valid 6-digit pincode." };
        return { ok: true };
      }

      return { ok: true };
    };

    const requiredFields = ["full_name", "phone", "address_line1", "city", "state", "pincode"];

    const validateAll = ({ showErrors = false } = {}) => {
      let allOk = true;
      let firstError = null;

      const inputs = form.querySelectorAll("input[name]");
      inputs.forEach((input) => {
        const name = input.name;
        const res = validateField(name, input.value);
        const isRequired = requiredFields.includes(name);

        if ((isRequired || name === "email") && !res.ok) {
          allOk = false;

          if (showErrors || input.dataset.touched === "1") {
            markInvalid(input, res.message);
          } else {
            clearMarks(input);
          }

          if (!firstError) firstError = res.message;
        } else {
          // valid or empty optional
          if (!isRequired && name !== "email" && input.value.trim() === "") clearMarks(input);
          else if (name === "email" && input.value.trim() === "") clearMarks(input);
          else markValid(input);
        }
      });

      payBtn.disabled = !allOk;
      payBtn.style.opacity = allOk ? "1" : "0.6";
      payBtn.style.cursor = allOk ? "pointer" : "not-allowed";

      if (showErrors) {
        if (!allOk && firstError) showError(firstError);
        else clearError();
      }

      return allOk;
    };

    const attachLiveValidation = () => {
      const inputs = form.querySelectorAll("input[name]");
      inputs.forEach((input) => {
        const name = input.name;

        input.addEventListener("input", () => {
          if (name === "phone") input.value = String(input.value || "").replace(/\D/g, "").slice(0, 10);
          if (name === "pincode") input.value = String(input.value || "").replace(/\D/g, "").slice(0, 6);
          validateAll({ showErrors: false });
        });

        input.addEventListener("blur", () => {
          input.dataset.touched = "1";
          validateAll({ showErrors: false });

          const res = validateField(name, input.value);
          const isRequired = requiredFields.includes(name);
          if ((isRequired || name === "email") && !res.ok) showError(res.message);
          else clearError();
        });
      });
    };

    // ---------- Build payload ----------
    const buildShippingAndCustomer = () => {
      const fd = new FormData(form);
      const raw = Object.fromEntries(fd.entries());

      const full_name = sanitizeText(raw.full_name);
      const phone10 = normalizePhone10(raw.phone);
      const email = sanitizeText(raw.email).toLowerCase();
      const address_line1 = sanitizeText(raw.address_line1);
      const address_line2 = sanitizeText(raw.address_line2);
      const city = sanitizeText(raw.city);
      const state = sanitizeText(raw.state);
      const pincode = normalizePincode6(raw.pincode);

      return {
        shipping: {
          full_name,
          phone: phone10,
          email: email || null,
          address_line1,
          address_line2: address_line2 || null,
          city,
          state,
          pincode
        },
        customer: {
          name: full_name,
          contact: `+91${phone10}`,
          email: email || undefined
        }
      };
    };

    // ---------- Init ----------
    statusEl.textContent = "✅ Checkout JS loaded";
    renderOrderSummary();
    attachLiveValidation();
    validateAll({ showErrors: false });

    // ---------- Pay ----------
    let isProcessing = false;

    payBtn.addEventListener("click", async () => {
      // mark all fields touched and show errors (if any)
      form.querySelectorAll("input[name]").forEach(i => (i.dataset.touched = "1"));
      const ok = validateAll({ showErrors: true });
      if (!ok) return;

      if (isProcessing) return;

      try {
        isProcessing = true;
        payBtn.disabled = true;
        payBtn.textContent = "Processing…";
        clearError();
        statusEl.textContent = "Creating payment…";

        const cartMod = await import("./assets/cart.js");
        const sbMod = await import("./assets/supabase.js");

        const cart = cartMod.getCart?.() || [];
        if (!cart.length) {
          showError("Your cart is empty. Please add products first.");
          statusEl.textContent = "";
          return;
        }

        const { data: sess } = await sbMod.supabase.auth.getSession();
        const session = sess?.session;
        if (!session?.access_token) {
          showError("You are not logged in. Please login before paying.");
          statusEl.textContent = "";
          return;
        }

        const { shipping, customer } = buildShippingAndCustomer();
        const payloadCart = cart.map(i => ({ product_id: i.product_id, qty: i.qty }));

        const { data, error } = await sbMod.supabase.functions.invoke("create-payment-link", {
          body: { cart: payloadCart, shipping, customer }
        });

        if (error || !data?.payment_link_url) {
          showError("Payment setup failed. Please try again.");
          statusEl.textContent = "";
          return;
        }

        statusEl.textContent = "Redirecting to Razorpay…";
        window.location.href = data.payment_link_url;

      } catch (e) {
        showError(String(e?.message ?? e));
        statusEl.textContent = "";
        console.error(e);
      } finally {
        isProcessing = false;
        payBtn.textContent = "Pay with Razorpay";
        // re-check validity (keeps disabled if invalid)
        validateAll({ showErrors: false });
      }
    });
  </script>
</body>
</html>
