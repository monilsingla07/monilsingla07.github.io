<!doctype html>
<html>
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CKQ1EXBHY6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-CKQ1EXBHY6');
</script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Profile — AhamStree</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400;1,600&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,300&display=swap" rel="stylesheet">
<link rel="stylesheet" href="assets/styles.css" />
</head>
<body>
  <div id="header"></div>

  <div class="container">
    <h2 style="margin-top:0;">Profile</h2>

    <div id="app" class="card" style="padding:16px;border-radius:16px;max-width:860px;">
      <div class="small">Loading…</div>
    </div>
  </div>

  <div id="footer"></div>

  <script type="module">
    import { renderHeader, renderFooter, hydrateHeaderAuth } from "./assets/ui.js";
    import { supabase } from "./assets/supabase.js";
    import { escapeHtml, escapeAttr } from "./assets/safe.js";

    document.getElementById("header").innerHTML = renderHeader("account");
    document.getElementById("footer").innerHTML = renderFooter();
    hydrateHeaderAuth();

    const app = document.getElementById("app");

    const { data: sess } = await supabase.auth.getSession();
    const user = sess?.session?.user;

    if (!user) {
      window.location.href = "login.html";
    }

    function renderForm(p) {
      app.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:flex-start;">
          <div>
            <div style="font-weight:900;">My Details</div>
            <div class="small" style="margin-top:6px;">Email: ${escapeHtml(user.email ?? "-")}</div>
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <a class="btn secondary" href="orders.html">Orders</a>
            <button id="logout" class="btn secondary">Log out</button>
          </div>
        </div>

        <hr/>

        <div style="display:grid;gap:10px;grid-template-columns: 1fr 1fr;">
          <div style="grid-column: 1 / -1;">
            <label class="small">Full name</label>
            <input id="full_name" class="input" value="${escapeAttr(p.full_name ?? "")}" autocomplete="name" />
          </div>

          <div>
            <label class="small">Phone</label>
            <input id="phone" class="input" value="${escapeAttr(p.phone ?? "")}" inputmode="numeric" autocomplete="tel" />
          </div>

          <div>
            <label class="small">Pincode</label>
            <input id="pincode" class="input" value="${escapeAttr(p.pincode ?? "")}" inputmode="numeric" autocomplete="postal-code" />
          </div>

          <div style="grid-column: 1 / -1;">
            <label class="small">Address line 1</label>
            <input id="address_line1" class="input" value="${escapeAttr(p.address_line1 ?? "")}" autocomplete="address-line1" />
          </div>

          <div style="grid-column: 1 / -1;">
            <label class="small">Address line 2</label>
            <input id="address_line2" class="input" value="${escapeAttr(p.address_line2 ?? "")}" autocomplete="address-line2" />
          </div>

          <div>
            <label class="small">City</label>
            <input id="city" class="input" value="${escapeAttr(p.city ?? "")}" autocomplete="address-level2" />
          </div>

          <div>
            <label class="small">State</label>
            <input id="state" class="input" value="${escapeAttr(p.state ?? "")}" autocomplete="address-level1" />
          </div>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;">
          <button id="save" class="btn">Save profile</button>
          <div id="status" class="small" style="align-self:center;"></div>
        </div>
      `;

      document.getElementById("logout").onclick = async () => {
        await supabase.auth.signOut();
        window.location.href = "login.html";
      };

      document.getElementById("save").onclick = async () => {
        const status = document.getElementById("status");
        status.textContent = "Saving…";

        const payload = {
          user_id: user.id,
          full_name: document.getElementById("full_name").value.trim() || null,
          phone: document.getElementById("phone").value.trim() || null,
          address_line1: document.getElementById("address_line1").value.trim() || null,
          address_line2: document.getElementById("address_line2").value.trim() || null,
          city: document.getElementById("city").value.trim() || null,
          state: document.getElementById("state").value.trim() || null,
          pincode: document.getElementById("pincode").value.trim() || null,
          updated_at: new Date().toISOString(),
        };

        const { error } = await supabase.from("profiles").upsert(payload);
        status.textContent = error ? ("Error: " + error.message) : "Saved ✅";
      };
    }

    // load or create empty profile
    const { data: prof, error: pe } = await supabase
      .from("profiles")
      .select("*")
      .eq("user_id", user.id)
      .maybeSingle();

    if (pe) {
      app.innerHTML = `<div class="small">Error loading profile: ${escapeHtml(pe.message)}</div>`;
    } else {
      renderForm(prof ?? {});
    }
  </script>
</body>
</html>
