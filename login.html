<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Account — AhamStree</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body>
  <div id="header"></div>

  <div class="container">
    <h2 style="margin-top:0;">Account</h2>

       <div id="app" class="card" style="padding:16px;border-radius:16px;max-width:680px;">
      <div class="small">Loading account…</div>
    </div>
  </div>

  <div id="footer"></div>

  <script type="module">
    import { renderHeader, renderFooter, hydrateHeaderAuth } from "/assets/ui.js";
import { supabase } from "/assets/supabase.js";


    document.getElementById("header").innerHTML = renderHeader("login");
    hydrateHeaderAuth();
document.getElementById("footer").innerHTML = renderFooter();



    const app = document.getElementById("app");

        function renderLoggedOut() {
  app.innerHTML = `
    <div style="font-weight:900;">Login / Sign up</div>
    <div class="small" style="margin-top:6px;">
      Create an account or log in with email + password.
    </div>

    <div style="margin-top:14px;display:grid;gap:10px;">
      <input id="fullName" class="input" type="text" placeholder="Full name" />
      <input id="phone" class="input" type="tel" placeholder="Phone number" />
      <input id="email" class="input" type="email" placeholder="Email address" />
      <input id="password" class="input" type="password" placeholder="Password (min 6 chars)" />
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
      <button id="signup" class="btn">Create account</button>
      <button id="login" class="btn secondary">Log in</button>
    </div>

    <div id="status" class="small" style="margin-top:10px;"></div>
  `;

  const status = document.getElementById("status");

  const getForm = () => ({
    full_name: document.getElementById("fullName").value.trim(),
    phone: document.getElementById("phone").value.trim(),
    email: document.getElementById("email").value.trim(),
    password: document.getElementById("password").value,
  });

  document.getElementById("signup").onclick = async () => {
    const { full_name, phone, email, password } = getForm();

    if (!email) return (status.textContent = "Please enter an email.");
    if (!password || password.length < 6) return (status.textContent = "Password must be at least 6 characters.");

    status.textContent = "Creating account… check your email to verify.";

    // store profile draft so we can write it after user confirms/signs in
    localStorage.setItem("pending_profile", JSON.stringify({ full_name, phone }));

    const { error } = await supabase.auth.signUp({
      email,
      password,
      options: {
        emailRedirectTo: window.location.origin + "/login.html",
      },
    });

    status.textContent = error
      ? ("Error: " + error.message)
      : "Account created. Please verify your email, then come back to log in.";
  };

  document.getElementById("login").onclick = async () => {
    const { email, password } = getForm();

    if (!email) return (status.textContent = "Please enter an email.");
    if (!password) return (status.textContent = "Please enter a password.");

    status.textContent = "Logging in…";

    const { error } = await supabase.auth.signInWithPassword({ email, password });

    status.textContent = error ? ("Error: " + error.message) : "Logged in ✅";
  };
}


function renderLoggedIn(email) {
  app.innerHTML = `
    <div style="font-weight:900;">My Account</div>
    <div class="small" style="margin-top:6px;">Signed in as ${email}</div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;">
      <a class="btn secondary" href="orders.html">Orders</a>
      <a class="btn secondary" href="profile.html">Profile</a>
      <button id="logout" class="btn">Log out</button>
    </div>
  `;

  document.getElementById("logout").onclick = async () => {
    await supabase.auth.signOut();
  };
}

async function upsertProfileIfPending(userId) {
  const raw = localStorage.getItem("pending_profile");
  if (!raw) return;

  const pending = JSON.parse(raw);
  localStorage.removeItem("pending_profile");

  // Write profile row (requires RLS policy allowing user to upsert their own profile)
  await supabase.from("profiles").upsert({
    user_id: userId,
    full_name: pending.full_name || null,
    phone: pending.phone || null,
  });
}

    // Initial render
    const { data: sessionData } = await supabase.auth.getSession();
    const userEmail = sessionData?.session?.user?.email;
    if (userEmail) renderLoggedIn(userEmail);
    else renderLoggedOut();

    // Keep in sync if auth changes
    supabase.auth.onAuthStateChange(async (_event, session) => {
  hydrateHeaderAuth();

  const e = session?.user?.email;
  const uid = session?.user?.id;

  if (e && uid) {
    await upsertProfileIfPending(uid);
    renderLoggedIn(e);
  } else {
    renderLoggedOut();
  }
});

  </script>
</body>
</html>
