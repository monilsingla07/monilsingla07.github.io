<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Wishlist — AhamStree</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400;1,600&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,300&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="assets/styles.css" />
</head>

<body>
  <div id="header"></div>

  <div class="container" style="padding-top: 40px; padding-bottom: 40px;">
    <h1 style="font-size: 32px; margin-bottom: 8px;">My Wishlist</h1>
    <p style="color: var(--text-light); margin-bottom: 32px;">
      Your saved sarees
    </p>

    <div id="wishlistStatus" style="text-align: center; padding: 20px;"></div>
    <div id="wishlistGrid" class="grid grid-3"></div>
  </div>

  <div id="footer"></div>

  <script type="module">
    import { renderHeader, renderFooter, hydrateHeaderAuth } from "./assets/ui.js";
    import { getWishlist, removeFromWishlist } from "./assets/wishlist.js";
    import { escapeHtml, escapeAttr, safeSrc } from "./assets/safe.js";

    document.getElementById("header").innerHTML = renderHeader("wishlist");
    hydrateHeaderAuth();
    document.getElementById("footer").innerHTML = renderFooter();

    const wishlistGrid = document.getElementById('wishlistGrid');
    const wishlistStatus = document.getElementById('wishlistStatus');

    // Load wishlist
    loadWishlist();

    function moneyINR(v) {
      const n = Number(v);
      if (!Number.isFinite(n)) return "";
      return "₹" + n.toLocaleString("en-IN", { maximumFractionDigits: 0 });
    }

    async function loadWishlist() {
      wishlistStatus.textContent = 'Loading...';

      const { data: products, error } = await getWishlist();

      if (error) {
        wishlistStatus.textContent = 'Error loading wishlist';
        return;
      }

      wishlistStatus.textContent = '';

      if (!products || products.length === 0) {
        wishlistGrid.innerHTML = `
          <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px;">
            <p style="font-size: 18px; color: var(--text-light); margin-bottom: 20px;">
              Your wishlist is empty
            </p>
            <a href="products.html" class="btn">Browse Products</a>
          </div>
        `;
        return;
      }

      wishlistGrid.innerHTML = products.map(product => {
        const price = Number(product.price_inr || 0);
        const sale = product.sale_price_inr === null || product.sale_price_inr === undefined
          ? null
          : Number(product.sale_price_inr || 0);

        const showSale = Number.isFinite(sale) && sale > 0 && sale < price && Number.isFinite(price);
        const priceHtml = showSale
          ? `<span style="font-weight:900;">${moneyINR(sale)}</span> <span class="small" style="opacity:.7;text-decoration:line-through;">${moneyINR(price)}</span>`
          : `<span style="font-weight:900;">${moneyINR(price)}</span>`;

        const imgHtml = product.image_url
          ? `<img src="${safeSrc(product.image_url)}" alt="${escapeAttr(product.title || 'Product')}" loading="lazy">`
          : `<div style="height:260px;background:#fafafa;border-radius:12px;"></div>`;

        return `
          <div class="card product-card">
            <a href="product.html?id=${encodeURIComponent(product.id)}" style="text-decoration:none;color:inherit;">
              ${imgHtml}
            </a>
            <div class="p">
              <a href="product.html?id=${encodeURIComponent(product.id)}" style="text-decoration: none; color: inherit;">
                <div class="product-title">${escapeHtml(product.title || '')}</div>
                <div class="product-price" style="margin-top:6px;">${priceHtml}</div>
              </a>
              <button
                class="btn secondary js-remove"
                style="width: 100%; margin-top: 12px;"
                data-id="${escapeAttr(product.id)}">
                Remove
              </button>
            </div>
          </div>
        `;
      }).join('');

      // Wire remove buttons
      wishlistGrid.querySelectorAll('.js-remove').forEach(btn => {
        btn.addEventListener('click', async () => {
          const productId = btn.getAttribute('data-id');
          if (!productId) return;
          if (!confirm('Remove this item from wishlist?')) return;

          const { success } = await removeFromWishlist(productId);
          if (success) loadWishlist();
        });
      });
    }
  </script>
</body>
</html>
